<!DOCTYPE html> 
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-468B94S87K"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-468B94S87K');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analysis of KY Road Closures: Table</title>
    <link rel="stylesheet" href="../css/analysis_by_table.css">
</head>

<body>
    <nav class="main-nav">
        <a class="nav-link" href="../index.html">Home</a>
        <a class="nav-link" href="analysis_by_count.html">Analysis by Count</a>
        <a class="nav-link" href="analysis_by_duration.html">Analysis by Duration</a>
  <a class="nav-link" href="analysis_by_maptable.html">Map + Table View</a>
  <a class="nav-link" href="analysis_by_table.html">Table View</a>
  <a class="nav-link" href="powerbi.html">Power BI Dashboard</a>
        <a class="nav-link" href="about.html">About</a>
    </nav>
    <div style="text-align: center;">
        <h1>Interactive Analysis of KY Road Closures</h1>
        <h2>Data refreshes daily 12:30am EST</h2>

<!-- I'm using AG Grid for this page. -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-grid.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-theme-alpine.css" />
<script src="https://cdn.jsdelivr.net/npm/ag-grid-community@30.2.0/dist/ag-grid-community.min.noStyle.js"></script>

<!-- Download buttons -->
<div style="margin-bottom:1rem;display:flex;gap:1rem;flex-wrap:wrap;justify-content:center;">
  <button id="download-full-csv" class="font-bold">Download Full CSV</button>
  <button id="download-filtered-csv" class="font-bold">Download Filtered CSV</button>
  <button id="refresh-data-btn" class="font-bold" style="background:#e9f5ff;color:#003764;border:1px solid #003764;">Refresh Data</button>
</div>

<div style="text-align:center;margin-bottom:8px;font-size:0.95em;color:#333;">
  <span id="dataStatus">Loading data...</span>
</div>

<!-- I'm over documenting for the sake of my sanity -->
<!-- Quite a bit of the code below can be found on the AG Grid website or googling. -->
<!-- https://www.ag-grid.com/javascript-data-grid/getting-started/ -->
<!-- AI doesn't always get it right with this library. -->

<!-- I have to setup somewhere in the HTML for the script to interact with the html -->
<div id="aggrid-table-container">
  <div id="myGrid" class="ag-theme-alpine"></div>
</div>

<script src="../js/idb_data_loader.js"></script>
<script>
let gridApi = null;  // This will hold our table so we can control it
let fullData = [];   // This will store ALL our road closure data

// Function to initialize/update the table with data
function initializeTable(data) {
  fullData = data;
  
  // Define the columns we want and how they should look
  const columnDefs = 
  [
    { headerName: "County", field: "County_Name", sortable: true, filter: true, resizable: true,},
    { headerName: "Route", field: "Route_Label", sortable: true, filter: true, resizable: true },
    { headerName: "Road Name", field: "Road_Name", sortable: true, filter: true, resizable: true, cellStyle: {textAlign: 'left'} },
    { headerName: "Milepoint", field: "Milepoint", sortable: true, filter: true, resizable: true,valueFormatter: params => Number(params.value).toFixed(2), cellStyle: {textAlign: 'center'}  }, // adding rounding for readability
    { headerName: "latitude", field: "latitude", sortable: true, filter: true, resizable: true },
    { headerName: "longitude", field: "longitude", sortable: true, filter: true, resizable: true },
    { headerName: "Reported On", field: "Reported_On", sortable: true, filter: true, resizable: true, cellStyle: {textAlign: 'left'}, sort: 'desc', sortindex: 0 }, // default sort by most recent
    { headerName: "End Date", field: "End_Date", sortable: true, filter: true, resizable: true, cellStyle: {textAlign: 'left'}  },
    { headerName: "Duration(Hours)", field: "Duration_Hours", sortable: true, filter: true, resizable: true, valueFormatter: params => Number(params.value).toFixed(2)}, // adding rounding for readability
    { headerName: "Comments", field: "Comments", sortable: true, filter: true, resizable: true, cellStyle: {textAlign: 'left'}}
  ];
  
  // Set up all the table options and rules
  const gridOptions = {
    columnDefs: columnDefs,
    rowData: data,
    
    defaultColDef: 
    {
      flex: 1,
      minWidth: 120,
      filter: true,
      sortable: true,
      resizable: true,
      floatingFilter: true // Show little search boxes under each header
    },
    pagination: true,
    paginationPageSize: 10,
    domLayout: 'autoHeight',
    onGridReady: function(params) 
    {
      gridApi = params.api;
      // Make all columns auto-size to fit their content perfectly
      params.columnApi.autoSizeColumns();
    }
  };
  
  // Generate the table
  const gridDiv = document.getElementById('myGrid');
  gridDiv.innerHTML = ''; // Clear any existing grid
  new agGrid.Grid(gridDiv, gridOptions);
}

// Load data using IDB-first strategy
loadData({
  onStatusUpdate: function(status) {
    const el = document.getElementById('dataStatus');
    if (el) el.textContent = status.message || '';
  },
  onDataReady: function(data) {
    initializeTable(data);
  }
}).catch(err => {
  console.error('Failed to load data', err);
  document.getElementById('dataStatus').textContent = 'Error loading data';
});

// DOWNLOAD BUTTON SETUP
document.addEventListener('DOMContentLoaded', function() 
{
  // "Download Full CSV"
  document.getElementById('download-full-csv').addEventListener('click', function() 
  {
    const csv = convertToCSV(fullData);
    downloadCSV(csv, 'road_closures_full.csv');
  }); 
  
  // "Download Filtered CSV"
  document.getElementById('download-filtered-csv').addEventListener('click', function() 
  {
    if (!gridApi) {
      alert('Table not ready yet');
      return;
    }
    const filteredRows = [];
    gridApi.forEachNodeAfterFilterAndSort(node => filteredRows.push(node.data));
    const csv = convertToCSV(filteredRows);
    downloadCSV(csv, 'road_closures_filtered.csv');
  });
  
  // "Refresh Data" button
  document.getElementById('refresh-data-btn').addEventListener('click', async function() {
    const btn = this;
    btn.disabled = true;
    const origText = btn.textContent;
    btn.textContent = 'Refreshing...';
    
    try {
      const data = await refreshData(function(status) {
        const el = document.getElementById('dataStatus');
        if (el) el.textContent = status.message || '';
      });
      initializeTable(data);
    } catch (err) {
      console.error('Refresh failed', err);
      document.getElementById('dataStatus').textContent = 'Refresh failed: ' + err.message;
    }
    
    btn.textContent = origText;
    btn.disabled = false;
  });
});

// Converts our data into CSV format
function convertToCSV(arr) {
  // These are the columns we want, in the order we want them
  const keys = [
    "County_Name", "Route_Label", "Road_Name", "Milepoint",
    "latitude", "longitude", "Reported_On", "End_Date", 
    "Duration_Hours", "Comments"
  ];
  
  const header = keys.join(',');
  // AI use : this was tricky to figure out.
  const rows = arr.map(row => keys.map(k => '"' + String(row[k] ?? '').replace(/"/g, '""') + '"').join(','));
  return header + '\n' + rows.join('\n');
}

// Function to download the CSV file
function downloadCSV(csv, filename) {
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}
</script>
<section>
  <p><b>UNDERSTAND THE DATA:</b> 
    This table represents a daily snapshot from a real-time decision support system.<br>
    The real-time system processes data on Kentucky roadways every 2 minutes.  <br>
    <b>"Reported On"</b> and <b>"End Date"</b> are obtained through an aggregation of <b>min(timestamp)</b> and <b>max(timestamp)</b>.<br>
    Events that are ongoing will typically display with "End Date" of Midnight (00:00) from the previous day's date<br>
    since the last known occurrence for that road closure was processed at Midnight (00:00) EST.<br>
    </p>

</section>
</body>
</html>