<!DOCTYPE html> 
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Analysis of KY Road Closures Table View</title>
    <link rel="stylesheet" href="../css/analysis_by_table.css">
</head>
<body>
    <nav class="main-nav">
        <a class="nav-link" href="../index.html">Home</a>
        <a class="nav-link" href="analysis_by_count.html">Analysis by Count</a>
        <a class="nav-link" href="analysis_by_duration.html">Analysis by Duration</a>
        <a class="nav-link" href="analysis_by_map.html">Map View</a>
        <a class="nav-link" href="analysis_by_table.html">Table View</a>
        <a class="nav-link" href="powerbi.html">Power BI Dashboard</a>
        <a class="nav-link" href="about.html">About</a>
    </nav>
    <div style="text-align: center;">
        <h1>Interactive Analysis of KY Road Closures</h1>
        <h2>Data refreshes daily 12:30am EST</h2>

<!-- I'm using AG Grid for this page. -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-grid.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-theme-alpine.css" />
<script src="https://cdn.jsdelivr.net/npm/ag-grid-community@30.2.0/dist/ag-grid-community.min.noStyle.js"></script>

<!-- Download buttons -->
<div style="margin-bottom:1rem;display:flex;gap:1rem;flex-wrap:wrap;justify-content:center;">
  <button id="download-full-csv" class="font-bold">Download Full CSV</button>
  <button id="download-filtered-csv" class="font-bold">Download Filtered CSV</button>
</div>

<!-- I'm over documenting for the sake of my sanity -->
<!-- Quite a bit of the code below can be found on the AG Grid website or googling. -->
<!-- https://www.ag-grid.com/javascript-data-grid/getting-started/ -->
<!-- AI doesn't always get it right with this library. -->

<!-- I have to setup somewhere in the HTML for the script to interact with the html -->
<div id="aggrid-table-container">
  <div id="myGrid" class="ag-theme-alpine"></div>
</div>

<script>
let gridApi = null;  // This will hold our table so we can control it
let fullData = [];   // This will store ALL our road closure data

// Fetch the data and create the table
fetch('../data/data_v4_final_roadclosures.json')
  .then(response => response.json())
  .then(data => 
  {
    fullData = data;
    
    // Define the columns we want and how they should look
    const columnDefs = 
    [
      { headerName: "County", field: "County_Name", sortable: true, filter: true, resizable: true,},
      { headerName: "Route", field: "Route_Label", sortable: true, filter: true, resizable: true },
      { headerName: "Road Name", field: "Road_Name", sortable: true, filter: true, resizable: true, cellStyle: {textAlign: 'left'} },
      { headerName: "Milepoint", field: "Milepoint", sortable: true, filter: true, resizable: true,valueFormatter: params => Number(params.value).toFixed(2), cellStyle: {textAlign: 'center'}  }, // adding rounding for readability
      { headerName: "latitude", field: "latitude", sortable: true, filter: true, resizable: true },
      { headerName: "longitude", field: "longitude", sortable: true, filter: true, resizable: true },
      { headerName: "Reported On", field: "Reported_On", sortable: true, filter: true, resizable: true, cellStyle: {textAlign: 'left'}, sort: 'desc', sortindex: 0 }, // default sort by most recent
      { headerName: "End Date", field: "End_Date", sortable: true, filter: true, resizable: true, cellStyle: {textAlign: 'left'}  },
      { headerName: "Duration(Hours)", field: "Duration_Hours", sortable: true, filter: true, resizable: true, valueFormatter: params => Number(params.value).toFixed(2)}, // adding rounding for readability
      { headerName: "Comments", field: "Comments", sortable: true, filter: true, resizable: true, cellStyle: {textAlign: 'left'}}
    ];
    
    // Set up all the table options and rules
    const gridOptions = {
      columnDefs: columnDefs,
      rowData: data,
      
      defaultColDef: 
      {
        flex: 1,
        minWidth: 120,
        filter: true,
        sortable: true,
        resizable: true,
        floatingFilter: true // Show little search boxes under each header
      },
      pagination: true,
      paginationPageSize: 10,
      domLayout: 'autoHeight',
      onGridReady: function(params) 
      {
        gridApi = params.api;
        // Make all columns auto-size to fit their content perfectly
        params.columnApi.autoSizeColumns();
      }
    };
    
    // Generate the table
    new agGrid.Grid(document.getElementById('myGrid'), gridOptions);
  });

// DOWNLOAD BUTTON SETUP
document.addEventListener('DOMContentLoaded', function() 
{
  // "Download Full CSV"
  document.getElementById('download-full-csv').addEventListener('click', function() 
  {
    const csv = convertToCSV(fullData);
    downloadCSV(csv, 'road_closures_full.csv');
  }); 
  // "Download Filtered CSV"
  document.getElementById('download-filtered-csv').addEventListener('click', function() 
  {
    const filteredRows = [];
    gridApi.forEachNodeAfterFilterAndSort(node => filteredRows.push(node.data));
    const csv = convertToCSV(filteredRows);
    downloadCSV(csv, 'road_closures_filtered.csv');
  });
});

// Converts our data into CSV format
function convertToCSV(arr) {
  // These are the columns we want, in the order we want them
  const keys = [
    "County_Name", "Route_Label", "Road_Name", "Milepoint",
    "latitude", "longitude", "Reported_On", "End_Date", 
    "Duration_Hours", "Comments"
  ];
  
  const header = keys.join(',');
  // AI use : this was tricky to figure out.
  const rows = arr.map(row => keys.map(k => '"' + String(row[k] ?? '').replace(/"/g, '""') + '"').join(','));
  return header + '\n' + rows.join('\n');
}

// Function to download the CSV file
function downloadCSV(csv, filename) {
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}
</script>
<section>
  <p><b>Please note:</b> This table represents a daily snapshot of real-time data via a batch process.<br>
    "Reported On" and "End Date" are obtained through an aggregation of <b>min(timestamp)</b> and <b>max(timestamp)</b>.<br>
    Events that are ongoing will typically display an "End Date" of Midnight (00:00), since the data is exported at Midnight EST.<br>
    </p>

</section>
</body>
</html>