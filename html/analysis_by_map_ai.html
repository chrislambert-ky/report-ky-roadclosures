<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-PGFTJRPTPX"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-PGFTJRPTPX');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analysis by Mapping - KY Road Closures</title>
    <!-- My stylesheet for this page -->
    <link rel="stylesheet" href="../css/analysis_by_map.css">
    <!-- Required Leaflet CSS for mapping -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <!-- MarkerCluster plugin CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <!-- Required Leaflet JS for mapping -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- MarkerCluster plugin JS -->
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
</head>
<body>
    <nav class="main-nav">
        <a class="nav-link" href="../index.html">Home</a>
        <a class="nav-link" href="analysis_by_count.html">Analysis by Count</a>
        <a class="nav-link" href="analysis_by_duration.html">Analysis by Duration</a>
        <a class="nav-link" href="analysis_by_map.html">Map View</a>
        <a class="nav-link" href="analysis_by_table.html">Table View</a>
        <a class="nav-link" href="powerbi.html">Power BI Dashboard</a>
        <a class="nav-link" href="about.html">About</a>
    </nav>
    <div style="text-align: center;">
        <h1>Interactive Analysis of KY Road Closures: by Location</h1>
        <h2>Data refreshes daily 12:30am EST</h2>
    </div>


<div style="text-align: center;">
  <div class="dropdown-filter-menus" style="display: inline-block;">

  <label for="yearFilter">Year:</label>
  <select id="yearFilter">
    <option value="">All Years</option>
    <!-- Options will be populated dynamically -->
  </select>
  <label for="districtFilter">District:</label>
  <select id="districtFilter">
    <option value="">All Districts</option>
    <!-- Options will be populated dynamically -->
  </select>
  <label for="countyFilter">County:</label>
  <select id="countyFilter">
    <option value="">All Counties</option>
    <!-- Options will be populated dynamically -->
  </select>

  <button id="clearFiltersBtn" style="margin-left: 16px;">Clear Filters</button>

  <script>
  // --- Dynamic Dropdowns and Map Filtering ---
  // These variables will be used by the main script as well
  let allData = [];
  let filteredData = [];

  function getUnique(arr, keyFn) {
    return [...new Set(arr.map(keyFn))].sort();
  }

  function getYear(dateStr) {
    if (!dateStr) return '';
    const d = new Date(dateStr);
    return isNaN(d) ? '' : d.getFullYear().toString();
  }

  function populateDropdown(id, options, label) {
    const select = document.getElementById(id);
    select.innerHTML = `<option value="">All ${label}</option>` +
      options.map(opt => `<option value="${opt}">${opt}</option>`).join('');
  }

  function filterData() {
    const year = document.getElementById('yearFilter').value;
    const district = document.getElementById('districtFilter').value;
    const county = document.getElementById('countyFilter').value;
    filteredData = allData.filter(item => {
      const itemYear = getYear(item.Reported_On);
      return (!year || itemYear === year) &&
             (!district || String(item.District_Number) === district) &&
             (!county || item.County_Name === county);
    });
  }

  function updateDropdowns() {
    // After filtering, get valid options for each dropdown
    const yearSet = getUnique(filteredData, item => getYear(item.Reported_On));
    let districtSet = getUnique(filteredData, item => String(item.District_Number));
    districtSet = districtSet.sort((a, b) => Number(a) - Number(b));
    const countySet = getUnique(filteredData, item => item.County_Name);
    populateDropdown('yearFilter', yearSet, 'Years');
    populateDropdown('districtFilter', districtSet, 'Districts');
    populateDropdown('countyFilter', countySet, 'Counties');
  }

  function updateMapMarkers() {
    if (typeof markers !== 'undefined') {
      markers.clearLayers();
      filteredData.forEach(closure => {
        if (closure.latitude && closure.longitude) {
          const marker = L.marker([parseFloat(closure.latitude), parseFloat(closure.longitude)]);
          marker.bindPopup(
            `<b>${closure.Road_Name}</b><br>` +
            `${closure.Comments}<br>` +
            `<b>County:</b> ${closure.County_Name}<br>` +
            `<b>Reported:</b> ${closure.Reported_On}<br>` +
            `<b>Duration (hrs):</b> ${closure.Duration_Hours}`
          );
          markers.addLayer(marker);
        }
      });
    }
  }

  function onFilterChange(e) {
    // Save current selections
    const prev = {
      year: document.getElementById('yearFilter').value,
      district: document.getElementById('districtFilter').value,
      county: document.getElementById('countyFilter').value
    };
    filterData();
    updateDropdowns();
    // Restore previous selection if still valid
    if (prev.year) document.getElementById('yearFilter').value = prev.year;
    if (prev.district) document.getElementById('districtFilter').value = prev.district;
    if (prev.county) document.getElementById('countyFilter').value = prev.county;
    filterData(); // filter again in case dropdowns changed
    updateMapMarkers();
  }

  // Wait for DOM and map to be ready
  document.addEventListener('DOMContentLoaded', function() {
    fetch('../data/data_v4_final_roadclosures.json')
      .then(response => response.json())
      .then(data => {
        allData = data;
        filteredData = data;
        updateDropdowns();
        updateMapMarkers();
        // Add event listeners
        ['yearFilter', 'districtFilter', 'countyFilter'].forEach(id => {
          document.getElementById(id).addEventListener('change', onFilterChange);
        });
        // Clear Filters button
        document.getElementById('clearFiltersBtn').addEventListener('click', function() {
          document.getElementById('yearFilter').value = '';
          document.getElementById('districtFilter').value = '';
          document.getElementById('countyFilter').value = '';
          filterData();
          updateDropdowns();
          updateMapMarkers();
        });
      });
  });
  </script>
  </div>
</div>

    <div style="text-align: center;">
      <div id="map" style="width: 800px; height: 600px; display: inline-block;"></div>
    </div>

<script>

// Leaflet Map
// =============================
// The following Leaflet map is based on their Quick Start example.
// https://leafletjs.com/examples/quick-start/
// I just had to fetch my data and start customizing the content.
// The performance was horrible with 10,000+ individual markers
// I had to use the Leaflet.markercluster plugin.

// latitude, longitude, and zoom to center of Kentucky
const map = L.map('map').setView([37.822295, -85.76819], 7);

// Add OpenStreetMap tiles as the base map layer
L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', 
{
    maxZoom: 19,
    attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
}).addTo(map);

// Create a marker cluster group to efficiently display thousands of points
const markers = L.markerClusterGroup({
    maxClusterRadius: 60,
    disableClusteringAtZoom: 12
});

// Fetch the road closure data and add markers to the map
fetch('../data/data_v4_final_roadclosures.json')
  .then(response => response.json())
  .then(data => {
    // Loop through each closure and create a marker
    data.forEach(closure => {
      const marker = L.marker([parseFloat(closure.latitude), parseFloat(closure.longitude)]);
      // Set up the popup that shows when you click a marker
      marker.bindPopup(
        `<b>${closure.Road_Name}</b><br>
         ${closure.Comments}<br>
         <b>County:</b> ${closure.County_Name}<br>
         <b>Reported:</b> ${closure.Reported_On}<br>
         <b>Duration (hrs):</b> ${closure.Duration_Hours}`
      );
      markers.addLayer(marker);
    });
    // Add all the markers to the map at once
    map.addLayer(markers);
  });

</script>

</body>
</html>