<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-468B94S87K"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-468B94S87K');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analysis of KY Road Closures: Duration</title>
    <link rel="stylesheet" href="../css/apache-viz.css">
    <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
</head>
<body>
    <nav class="main-nav">
        <a class="nav-link" href="../index.html">Home</a>
        <a class="nav-link" href="analysis_by_count.html">Analysis by Count</a>
        <a class="nav-link" href="analysis_by_duration.html">Analysis by Duration</a>
        <a class="nav-link" href="analysis_by_map.html">Map View</a>
        <a class="nav-link" href="analysis_by_table.html">Table View</a>
        <a class="nav-link" href="powerbi.html">Power BI Dashboard</a>
        <a class="nav-link" href="about.html">About</a>
    </nav>
    <div style="text-align: center;">
        <h1>Interactive Analysis of KY Road Closures: by Duration of Closures</h1>
        <h2>This page will provide analysis of road closures by duration.</h2>
        <h2>Data refreshes daily 12:30am EST</h2>
    </div>
<div style="text-align:center;margin-bottom:1.5rem;">
  <button id="resetFilterBtn" style="background:#E0E1E1;color:#003764;font-weight:bold;border:none;padding:0.6em 1.5em;border-radius:6px;cursor:pointer;font-size:1.1em;box-shadow:0 2px 8px rgba(0,0,0,0.04);transition:background 0.2s;">Reset Filter</button>
</div>
<div class="diagram-grid">
  <div class="chart-container">
    <div id="yearChart" style="width:100%;height:100%;"></div>
  </div>
  <div class="chart-container">
    <div id="monthChart" style="width:100%;height:100%;"></div>
  </div>
  <div class="chart-container">
    <div id="districtChart" style="width:100%;height:100%;"></div>
  </div>
  <div class="chart-container">
    <div id="countyChart" style="width:100%;height:100%;"></div>
  </div>
</div>
<div style="text-align:center;margin-top:8px;font-size:0.95em;color:#333;">
  <span id="dataStatus">Loading data...</span>
</div>

<script src="../js/idb_data_loader.js"></script>
<script>
var yearDom = document.getElementById('yearChart');
var yearChart = echarts.init(yearDom);
var monthDom = document.getElementById('monthChart');
var monthChart = echarts.init(monthDom);
var districtDom = document.getElementById('districtChart');
var districtChart = echarts.init(districtDom);
var countyDom = document.getElementById('countyChart');
var countyChart = echarts.init(countyDom);
var resetBtn = document.getElementById('resetFilterBtn');

let rawData = [];
let selectedYear = null;
let selectedMonth = null;
let selectedDistrict = null;
let selectedCounty = null;
let latestDistrictEntries = [];

const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

function parseDuration(value) {
  const num = parseFloat(value);
  return isNaN(num) ? 0 : num;
}

function formatDuration(value) {
  return Number(value.toFixed(1));
}

function formatHoursLabel(value) {
  if (!isFinite(value)) return '0';
  if (Math.abs(value) < 1000) {
    return value.toFixed(1);
  }
  const scaled = value / 1000;
  if (Math.abs(scaled) >= 100) {
    return `${scaled.toFixed(0)}K`;
  }
  return `${scaled.toFixed(1)}K`;
}

function filterData(options = {}) {
  const { excludeYear = false, excludeMonth = false, excludeDistrict = false, excludeCounty = false } = options;
  let data = rawData;
  if (!excludeYear && selectedYear !== null) {
    data = data.filter(closure => new Date(closure.Reported_On).getFullYear() === selectedYear);
  }
  if (!excludeMonth && selectedMonth !== null) {
    data = data.filter(closure => new Date(closure.Reported_On).getMonth() === selectedMonth);
  }
  if (!excludeDistrict && selectedDistrict !== null) {
    data = data.filter(closure => {
      const rawDistrict = closure.District_Number !== undefined && closure.District_Number !== null ? closure.District_Number : 'Unknown';
      const normalized = rawDistrict === 'Unknown' ? 'Unknown' : Number(rawDistrict);
      return normalized === selectedDistrict;
    });
  }
  if (!excludeCounty && selectedCounty !== null) {
    data = data.filter(closure => (closure.County_Name || 'Unknown') === selectedCounty);
  }
  return data;
}

function renderCharts() {
  const yearData = filterData({ excludeYear: true });
  const monthData = filterData({ excludeMonth: true });
  const districtData = filterData({ excludeDistrict: true });
  const countyData = filterData({ excludeCounty: true });

  // Year chart (sum durations per year)
  const yearDurations = {};
  yearData.forEach(closure => {
    const year = new Date(closure.Reported_On).getFullYear();
    const duration = parseDuration(closure.Duration_Hours);
    yearDurations[year] = (yearDurations[year] || 0) + duration;
  });
  const years = Object.keys(yearDurations).map(val => Number(val)).sort((a, b) => a - b);
  const yearValues = years.map(year => formatDuration(yearDurations[year] || 0));
  const yearOption = {
    tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' }, valueFormatter: function(value) { return formatHoursLabel(value); } },
    grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
    xAxis: { type: 'category', data: years, axisTick: { alignWithLabel: true } },
    yAxis: { type: 'value', name: 'Hours', axisLabel: { formatter: function(value) { return formatHoursLabel(value); } } },
    series: [{
      name: 'Total Duration (Hours)',
      type: 'bar',
      barWidth: '60%',
      data: yearValues,
      itemStyle: {
        color: function(params) {
          if (selectedYear !== null && years[params.dataIndex] === selectedYear) return '#5EB3E4';
          return '#5470C6';
        }
      },
      label: {
        show: true,
        position: 'top',
        color: '#000',
        formatter: function(params) {
          return formatHoursLabel(params.value);
        }
      }
    }]
  };
  yearChart.setOption(yearOption);

  // Month chart (sum durations per month)
  const monthDurations = Array(12).fill(0);
  monthData.forEach(closure => {
    const month = new Date(closure.Reported_On).getMonth();
    monthDurations[month] += parseDuration(closure.Duration_Hours);
  });
  const monthValues = monthDurations.map(val => formatDuration(val));
  const monthOption = {
    tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' }, valueFormatter: function(value) { return formatHoursLabel(value); } },
    grid: { left: '5%', right: '4%', bottom: '4%', top: '6%', containLabel: true },
    xAxis: { type: 'value', name: 'Hours', axisLabel: { formatter: function(value) { return formatHoursLabel(value); } } },
    yAxis: { type: 'category', data: monthNames, axisTick: { alignWithLabel: true }, inverse: true },
    series: [{
      name: 'Total Duration (Hours)',
      type: 'bar',
      barWidth: '60%',
      data: monthValues,
      itemStyle: {
        color: function(params) {
          if (selectedMonth !== null && params.dataIndex === selectedMonth) return '#5EB3E4';
          return '#5470C6';
        }
      },
      label: {
        show: true,
        position: 'right',
        color: '#000',
        formatter: function(params) {
          return formatHoursLabel(params.value);
        }
      }
    }]
  };
  monthChart.setOption(monthOption);

  // District chart (sum durations per district)
  const districtDurations = {};
  districtData.forEach(closure => {
    const rawDistrict = closure.District_Number !== undefined && closure.District_Number !== null ? closure.District_Number : 'Unknown';
    const district = rawDistrict === 'Unknown' ? 'Unknown' : Number(rawDistrict);
    districtDurations[district] = (districtDurations[district] || 0) + parseDuration(closure.Duration_Hours);
  });
  const districtEntries = Object.entries(districtDurations)
    .map(([district, total]) => ({ district: district === 'Unknown' ? 'Unknown' : Number(district), total }))
    .sort((a, b) => b.total - a.total);
  latestDistrictEntries = districtEntries;
  const districtNames = districtEntries.map(item => item.district === 'Unknown' ? 'Unknown' : `District ${item.district}`);
  const districtValues = districtEntries.map(item => formatDuration(item.total));
  const districtOption = {
    tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' }, valueFormatter: function(value) { return formatHoursLabel(value); } },
    grid: { left: '4%', right: '4%', bottom: '4%', top: '6%', containLabel: true },
    xAxis: { type: 'value', name: 'Hours', axisLabel: { formatter: function(value) { return formatHoursLabel(value); } } },
    yAxis: { type: 'category', data: districtNames, axisTick: { alignWithLabel: true }, inverse: true },
    series: [{
      name: 'Total Duration (Hours)',
      type: 'bar',
      barWidth: '60%',
      data: districtValues,
      label: {
        show: true,
        position: 'right',
        color: '#000',
        formatter: function(params) {
          return formatHoursLabel(params.value);
        }
      },
      itemStyle: {
        color: function(params) {
          const entry = districtEntries[params.dataIndex];
          if (selectedDistrict !== null && entry && entry.district === selectedDistrict) return '#5EB3E4';
          return '#5470C6';
        }
      }
    }]
  };
  districtChart.setOption(districtOption);

  // County chart (Top durations)
  const countyDurations = {};
  countyData.forEach(closure => {
    const county = closure.County_Name || 'Unknown';
    countyDurations[county] = (countyDurations[county] || 0) + parseDuration(closure.Duration_Hours);
  });
  const allCountyEntries = Object.entries(countyDurations)
    .map(([county, total]) => ({ county, total }))
    .sort((a, b) => b.total - a.total);
  const entryLimit = 15;
  const displayMin = 14;
  const entriesToTake = Math.max(displayMin, entryLimit);
  let countyEntries = allCountyEntries.slice(0, entriesToTake);
  if (selectedCounty !== null && !countyEntries.some(entry => entry.county === selectedCounty)) {
    const selectedEntry = allCountyEntries.find(entry => entry.county === selectedCounty);
    if (selectedEntry) {
      countyEntries = [selectedEntry, ...countyEntries].filter((entry, index, self) =>
        self.findIndex(e => e.county === entry.county) === index
      );
      countyEntries = countyEntries.slice(0, entriesToTake);
    }
  }
  const countyNames = countyEntries.map(item => item.county);
  const countyValues = countyEntries.map(item => formatDuration(item.total));
  const countyOption = {
    tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' }, valueFormatter: function(value) { return formatHoursLabel(value); } },
    grid: { left: '4%', right: '4%', bottom: '4%', top: '6%', containLabel: true },
    xAxis: { type: 'value', name: 'Hours', axisLabel: { formatter: function(value) { return formatHoursLabel(value); } } },
    yAxis: { type: 'category', data: countyNames, axisTick: { alignWithLabel: true }, inverse: true },
    series: [{
      name: 'Total Duration (Hours)',
      type: 'bar',
      barWidth: '60%',
      data: countyValues,
      label: {
        show: true,
        position: 'right',
        color: '#000',
        formatter: function(params) {
          return formatHoursLabel(params.value);
        }
      },
      itemStyle: {
        color: function(params) {
          if (selectedCounty !== null && countyNames[params.dataIndex] === selectedCounty) return '#5EB3E4';
          return '#5470C6';
        }
      }
    }]
  };
  countyChart.setOption(countyOption);
}

// Load data using IDB-first strategy
loadData({
  onStatusUpdate: function(status) {
    const el = document.getElementById('dataStatus');
    if (el) el.textContent = status.message || '';
  },
  onDataReady: function(data) {
    rawData = data;
    renderCharts();
  }
}).catch(err => {
  console.error('Failed to load data', err);
  document.getElementById('dataStatus').textContent = 'Error loading data';
});

yearChart.on('click', function(params) {
  if (params.componentType === 'series') {
    const year = Number(params.name);
    if (selectedYear === year) {
      selectedYear = null;
    } else {
      selectedYear = year;
    }
    selectedMonth = null;
    renderCharts();
  }
});

monthChart.on('click', function(params) {
  if (params.componentType === 'series') {
    const monthIdx = params.dataIndex;
    if (selectedMonth === monthIdx) {
      selectedMonth = null;
    } else {
      selectedMonth = monthIdx;
    }
    selectedYear = null;
    renderCharts();
  }
});

districtChart.on('click', function(params) {
  if (params.componentType === 'series') {
    const entry = latestDistrictEntries[params.dataIndex];
    if (!entry) return;
    const districtValue = entry.district;
    if (selectedDistrict === districtValue) {
      selectedDistrict = null;
    } else {
      selectedDistrict = districtValue;
    }
    renderCharts();
  }
});

countyChart.on('click', function(params) {
  if (params.componentType === 'series') {
    const countyName = params.name;
    if (selectedCounty === countyName) {
      selectedCounty = null;
    } else {
      selectedCounty = countyName;
    }
    renderCharts();
  }
});

resetBtn.addEventListener('click', function() {
  selectedYear = null;
  selectedMonth = null;
  selectedDistrict = null;
  selectedCounty = null;
  renderCharts();
});

window.addEventListener('resize', function() {
  yearChart.resize();
  monthChart.resize();
  districtChart.resize();
  countyChart.resize();
});
</script>

</body>
</html>
