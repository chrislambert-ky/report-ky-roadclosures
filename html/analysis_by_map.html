<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-468B94S87K"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-468B94S87K');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analysis of KY Road Closures: Map</title>
    <!-- My stylesheet for this page -->
    <link rel="stylesheet" href="../css/analysis_by_map.css">
    <!-- Required Leaflet CSS for mapping -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <!-- MarkerCluster plugin CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <!-- Required Leaflet JS for mapping -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- MarkerCluster plugin JS -->
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
</head>
<body>
    <nav class="main-nav">
        <a class="nav-link" href="../index.html">Home</a>
        <a class="nav-link" href="analysis_by_count.html">Analysis by Count</a>
        <a class="nav-link" href="analysis_by_duration.html">Analysis by Duration</a>
        <a class="nav-link" href="analysis_by_map.html">Map View</a>
        <a class="nav-link" href="analysis_by_table.html">Table View</a>
        <a class="nav-link" href="powerbi.html">Power BI Dashboard</a>
        <a class="nav-link" href="about.html">About</a>
    </nav>
    <div style="text-align: center;">
        <h1>Interactive Analysis of KY Road Closures: by Location</h1>
        <h2>Data refreshes daily 12:30am EST</h2>
    </div>


<div style="text-align: center;">
  <div class="dropdown-filter-menus" style="display: inline-block;">
    <div style="margin-bottom:1rem;">
      <span style="font-weight:bold;">Year:</span>
      <div id="yearMenu" class="main-nav" style="display:inline-flex;flex-wrap:wrap;gap:0.5rem;vertical-align:middle;"></div>
    </div>
    <div style="margin-bottom:1rem;">
      <span style="font-weight:bold;">District:</span>
      <div id="districtMenu" class="main-nav" style="display:inline-flex;flex-wrap:wrap;gap:0.5rem;vertical-align:middle;"></div>
    </div>
    <div style="margin-bottom:1rem; display: flex; align-items: center; justify-content: space-between; gap: 1rem;">
      <div style="flex:1; text-align:left;">
        <label for="countyFilter" style="font-weight:bold;">County:</label>
        <select id="countyFilter" style="font-size:1.1em;padding:0.3em 1em;border-radius:4px;border:1px solid #ccc;">
          <option value="">All Counties</option>
          <!-- Options will be populated dynamically -->
        </select>
      </div>
      <div style="text-align:right;">
        <button id="clearFiltersBtn" style="background:var(--light-gray);color:var(--blue);font-weight:bold;border:none;padding:0.6em 1.5em;border-radius:6px;cursor:pointer;font-size:1.1em;box-shadow:0 2px 8px rgba(0,0,0,0.04);transition:background 0.2s;">Clear Filters</button>
      </div>
    </div>
    <script>
  // --- Dynamic Dropdowns and Map Filtering ---
  // These variables will be used by the main script as well
  let allData = [];
  let filteredData = [];


  function getUnique(arr, keyFn) {
    return [...new Set(arr.map(keyFn))].sort();
  }

  function getYear(dateStr) {
    if (!dateStr) return '';
    const d = new Date(dateStr);
    return isNaN(d) ? '' : d.getFullYear().toString();
  }

  function populateDropdown(id, options, label) {
    const select = document.getElementById(id);
    select.innerHTML = `<option value="">All ${label}</option>` +
      options.map(opt => `<option value="${opt}">${opt}</option>`).join('');
  }

  function populateMenu(id, options, selected, label) {
    const menu = document.getElementById(id);
    menu.innerHTML = '';
    // Add "All" option
    const allBtn = document.createElement('a');
    allBtn.className = 'nav-link';
    allBtn.textContent = `All ${label}`;
    allBtn.style.cursor = 'pointer';
    if (!selected) {
      allBtn.style.background = 'var(--blue)';
      allBtn.style.color = '#fff';
    }
    allBtn.onclick = function() {
      menu.querySelectorAll('.nav-link').forEach(el => {
        el.style.background = '';
        el.style.color = '';
      });
      allBtn.style.background = 'var(--blue)';
      allBtn.style.color = '#fff';
      setFilter(id, '');
    };
    menu.appendChild(allBtn);
    options.forEach(opt => {
      const btn = document.createElement('a');
      btn.className = 'nav-link';
      btn.textContent = opt;
      btn.style.cursor = 'pointer';
      if (selected == opt) {
        btn.style.background = 'var(--blue)';
        btn.style.color = '#fff';
      }
      btn.onclick = function() {
        menu.querySelectorAll('.nav-link').forEach(el => {
          el.style.background = '';
          el.style.color = '';
        });
        btn.style.background = 'var(--blue)';
        btn.style.color = '#fff';
        setFilter(id, opt);
      };
      menu.appendChild(btn);
    });
  }

  function setFilter(menuId, value) {
    if (menuId === 'yearMenu') {
      document.getElementById('yearFilterValue').value = value;
    } else if (menuId === 'districtMenu') {
      document.getElementById('districtFilterValue').value = value;
    }
    onFilterChange();
  }

  function filterData() {
    const year = document.getElementById('yearFilterValue').value;
    const district = document.getElementById('districtFilterValue').value;
    const county = document.getElementById('countyFilter').value;
    filteredData = allData.filter(item => {
      const itemYear = getYear(item.Reported_On);
      return (!year || itemYear === year) &&
             (!district || String(item.District_Number) === district) &&
             (!county || item.County_Name === county);
    });
  }

  function updateDropdowns() {
    // Always show all years and districts from allData
    const yearSet = getUnique(allData, item => getYear(item.Reported_On));
    let districtSet = getUnique(allData, item => String(item.District_Number));
    districtSet = districtSet.sort((a, b) => Number(a) - Number(b));
    // County options filtered by selected district
    const selectedDistrict = document.getElementById('districtFilterValue').value;
    let countySet;
    if (selectedDistrict) {
      countySet = getUnique(
        allData.filter(item => String(item.District_Number) === selectedDistrict),
        item => item.County_Name
      );
    } else {
      countySet = getUnique(allData, item => item.County_Name);
    }
    populateMenu('yearMenu', yearSet, document.getElementById('yearFilterValue').value, 'Years');
    populateMenu('districtMenu', districtSet, document.getElementById('districtFilterValue').value, 'Districts');
    populateDropdown('countyFilter', countySet, 'Counties');
  }

  function updateMapMarkers() {
    if (typeof markers !== 'undefined') {
      markers.clearLayers();
      filteredData.forEach(closure => {
        if (closure.latitude && closure.longitude) {
          const marker = L.marker([parseFloat(closure.latitude), parseFloat(closure.longitude)]);
          marker.bindPopup(
            `<b>${closure.Road_Name}</b><br>` +
            `${closure.Comments}<br>` +
            `<b>County:</b> ${closure.County_Name}<br>` +
            `<b>Reported:</b> ${closure.Reported_On}<br>` +
            `<b>Duration (hrs):</b> ${closure.Duration_Hours}`
          );
          markers.addLayer(marker);
        }
      });
    }
  }

  function onFilterChange(e) {
    // Save current selections
    const prev = {
      year: document.getElementById('yearFilterValue').value,
      district: document.getElementById('districtFilterValue').value,
      county: document.getElementById('countyFilter').value
    };
    filterData();
    updateDropdowns();
    // Restore previous selection if still valid
    document.getElementById('yearFilterValue').value = prev.year;
    document.getElementById('districtFilterValue').value = prev.district;
    document.getElementById('countyFilter').value = prev.county;
    filterData(); // filter again in case dropdowns changed
    updateMapMarkers();
  }

  // Wait for DOM and map to be ready
  document.addEventListener('DOMContentLoaded', function() {
    // Add hidden inputs to store selected values
    if (!document.getElementById('yearFilterValue')) {
      const y = document.createElement('input');
      y.type = 'hidden';
      y.id = 'yearFilterValue';
      y.value = '';
      document.body.appendChild(y);
    }
    if (!document.getElementById('districtFilterValue')) {
      const d = document.createElement('input');
      d.type = 'hidden';
      d.id = 'districtFilterValue';
      d.value = '';
      document.body.appendChild(d);
    }
    fetch('../data/data_v4_final_roadclosures.json')
      .then(response => response.json())
      .then(data => {
        allData = data;
        filteredData = data;
        updateDropdowns();
        updateMapMarkers();
        // County dropdown event
        document.getElementById('countyFilter').addEventListener('change', onFilterChange);
        // Clear Filters button
        document.getElementById('clearFiltersBtn').addEventListener('click', function() {
          document.getElementById('yearFilterValue').value = '';
          document.getElementById('districtFilterValue').value = '';
          document.getElementById('countyFilter').value = '';
          filterData();
          updateDropdowns();
          updateMapMarkers();
        });
      });
  });
  </script>
  </div>
</div>

    <div style="text-align: center;">
      <div id="map" style="width: 800px; height: 600px; display: inline-block;"></div>
    </div>

<script>

// Leaflet Map
// =============================
// The following Leaflet map is based on their Quick Start example.
// https://leafletjs.com/examples/quick-start/
// I just had to fetch my data and start customizing the content.
// The performance was horrible with 10,000+ individual markers
// I had to use the Leaflet.markercluster plugin.

// latitude, longitude, and zoom to center of Kentucky
const map = L.map('map').setView([37.822295, -85.76819], 7);

// Add OpenStreetMap tiles as the base map layer
L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', 
{
    maxZoom: 19,
    attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
}).addTo(map);

// Create a marker cluster group to efficiently display thousands of points
const markers = L.markerClusterGroup({
    maxClusterRadius: 60,
    disableClusteringAtZoom: 12
});

// Fetch the road closure data and add markers to the map
fetch('../data/data_v4_final_roadclosures.json')
  .then(response => response.json())
  .then(data => {
    // Loop through each closure and create a marker
    data.forEach(closure => {
      const marker = L.marker([parseFloat(closure.latitude), parseFloat(closure.longitude)]);
      // Set up the popup that shows when you click a marker
      marker.bindPopup(
        `<b>${closure.Road_Name}</b><br>
         ${closure.Comments}<br>
         <b>County:</b> ${closure.County_Name}<br>
         <b>Reported:</b> ${closure.Reported_On}<br>
         <b>Duration (hrs):</b> ${closure.Duration_Hours}`
      );
      markers.addLayer(marker);
    });
    // Add all the markers to the map at once
    map.addLayer(markers);
  });

</script>

</body>
</html>